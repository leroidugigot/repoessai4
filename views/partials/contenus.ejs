<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Formations</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <link rel="stylesheet" href="/public/css/contenus.css" />
    <meta name="csrf-token" content="<%- locals.csrfToken %>" />
    <style>
      .formations-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 2rem;
        padding: 2rem;
        max-width: 1400px;
        margin: 0 auto;
      }

      .formation-card {
        background: linear-gradient(135deg, #1a1f35 0%, #131620 100%);
        border-radius: 1rem;
        padding: 1.5rem;
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.1);
        cursor: pointer;
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
      }

      .formation-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.05));
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .formation-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      }

      .formation-card:hover::before {
        opacity: 1;
      }

      .formation-header {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .formation-icon {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
        border-radius: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
        flex-shrink: 0;
      }

      .formation-icon i {
        font-size: 1.5rem;
        color: white;
        position: relative;
        z-index: 1;
        transition: transform 0.3s ease;
      }

      .formation-card:hover .formation-icon i {
        transform: scale(1.2);
      }

      .formation-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: white;
        line-height: 1.3;
        flex-grow: 1;
      }

      .formation-stats {
        display: flex;
        gap: 1rem;
        position: relative;
      }

      .stat {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #94a3b8;
        font-size: 0.9rem;
        padding: 0.5rem 0.75rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 0.5rem;
      }

      .formation-button {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
        padding: 0.75rem;
        border-radius: 0.75rem;
        font-weight: 500;
        transition: all 0.3s ease;
        border: none;
        width: 100%;
        position: relative;
        overflow: hidden;
      }

      .formation-button::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: 0.5s;
      }

      .formation-button:hover::before {
        left: 100%;
      }

      .formation-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .fade-in {
        animation: fadeInUp 0.6s ease forwards;
      }

      /* Styles pour la page d'inscription */
      .inscription-container {
        background: linear-gradient(135deg, #1a1f35 0%, #131620 100%);
        /*border-radius: 1.5rem;*/
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        /*border: 1px solid rgba(255, 255, 255, 0.1);*/
        animation: fadeInScale 0.6s ease-out;
        width: 100%;
      }

      @keyframes fadeInScale {
        from {
          opacity: 0;
          transform: scale(0.95);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      .inscription-header {
        text-align: center;
        margin-bottom: 2rem;
        position: relative;
      }

      .inscription-header::after {
        content: '';
        position: absolute;
        bottom: -1rem;
        left: 50%;
        transform: translateX(-50%);
        width: 100px;
        height: 3px;
        background: linear-gradient(90deg, #3b82f6, #1d4ed8);
        border-radius: 3px;
      }

      .inscription-title {
        font-size: 2.5rem;
        font-weight: 700;
        background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 0.5rem;
      }

      .inscription-subtitle {
        color: #94a3b8;
        font-size: 1.1rem;
      }

      .formation-details-wrapper {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 1rem;
        padding: 2rem;
        margin: 2rem 0;
      }

      .formation-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .detail-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 0.75rem;
        transition: all 0.3s ease;
      }

      .detail-item:hover {
        transform: translateY(-2px);
        background: rgba(255, 255, 255, 0.05);
      }

      .detail-icon {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
        border-radius: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .detail-icon i {
        font-size: 1.2rem;
        color: white;
      }

      .detail-content {
        flex: 1;
      }

      .detail-label {
        color: #94a3b8;
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
      }

      .detail-value {
        color: white;
        font-weight: 600;
      }

      .formation-actions {
        display: flex;
        gap: 1rem;
        padding-top: 2rem;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
      }

      .action-button {
        flex: 1;
        padding: 1rem;
        border-radius: 0.75rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
        cursor: pointer;
        border: none;
      }

      .action-button.primary {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
      }

      .action-button.secondary {
        background: rgba(255, 255, 255, 0.1);
        color: #94a3b8;
      }

      .action-button:hover {
        transform: translateY(-2px);
      }

      .action-button.primary:hover {
        box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
      }

      .action-button.secondary:hover {
        background: rgba(255, 255, 255, 0.15);
      }

      .action-button i {
        font-size: 1.1rem;
      }

      .formation-description {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 1rem;
        padding: 2rem;
        margin: 2rem 0;
        position: relative;
        overflow: hidden;
      }

      .formation-description::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(to bottom, #3b82f6, #1d4ed8);
        border-radius: 4px;
      }

      .description-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: white;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .description-title i {
        color: #3b82f6;
      }

      .description-content {
        color: #94a3b8;
        line-height: 1.7;
        font-size: 1.05rem;
        white-space: pre-line;
      }

      .description-content:empty::before {
        content: "Aucune description disponible pour cette formation.";
        color: #64748b;
        font-style: italic;
      }

      /* Styles pour la liste des modules */
      .modules-container {
        width: 100%;
        padding: 2rem;
      }

      .modules-header {
        text-align: center;
        margin-bottom: 3rem;
      }

      .modules-title {
        font-size: 2.5rem;
        font-weight: 700;
        background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 0.5rem;
      }

      .modules-subtitle {
        color: #94a3b8;
        font-size: 1.1rem;
      }

      .modules-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 2rem;
        width: 100%;
      }

      .module-card {
        background: linear-gradient(135deg, #1a1f35 0%, #131620 100%);
        border-radius: 1rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        position: relative;
        overflow: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .module-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.05));
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .module-card:hover:not(.locked) {
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      }

      .module-card:hover:not(.locked)::before {
        opacity: 1;
      }

      .module-header {
        display: flex;
        align-items: center;
        gap: 1.25rem;
        margin-bottom: 1rem;
      }

      .module-icon {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
        border-radius: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
      }

      .module-icon i {
        font-size: 1.25rem;
        color: white;
        transition: transform 0.3s ease;
      }

      .module-card:hover:not(.locked) .module-icon i {
        transform: scale(1.1);
      }

      .module-info {
        flex-grow: 1;
      }

      .module-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: white;
        margin-bottom: 0.5rem;
      }

      .module-meta {
        display: flex;
        gap: 1rem;
        font-size: 0.875rem;
        color: rgba(255, 255, 255, 0.7);
      }

      .module-meta span {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .module-meta i {
        font-size: 1rem;
      }

      .module-progress {
        height: 4px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 2px;
        margin-top: 1rem;
        overflow: hidden;
      }

      .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #2563eb, #1e40af);
        border-radius: 2px;
        transition: width 0.3s ease;
      }

      .locked {
        opacity: 0.7;
        cursor: not-allowed;
      }

      .locked .module-icon {
        background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
      }

      .locked::after {
        content: 'üîí';
        position: absolute;
        top: 1rem;
        right: 1rem;
        font-size: 1.25rem;
        opacity: 0.8;
      }

      .completed .module-icon {
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
      }

      .completed::after {
        content: '‚úì';
        position: absolute;
        top: 1rem;
        right: 1rem;
        font-size: 1.25rem;
        color: #059669;
      }

      @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
      }

      .locked:hover {
        animation: shake 0.5s cubic-bezier(0.36, 0.07, 0.19, 0.97) both;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div id="formationList" class="hidden">
        <!-- Liste des formations -->
      </div>

      <div id="moduleList" class="hidden">
        <!-- Liste des modules -->
      </div>

      <div id="contentDisplay" class="hidden">
        <!-- Contenu -->
      </div>
      <div id="breadcrumb"></div>
    </div>
    <script>
      // Fonction pour mettre √† jour le fil d'Ariane
      function updateBreadcrumb(formation = null, module = null) {
        const breadcrumb = document.getElementById('breadcrumb');
        if (!breadcrumb) return;

        let html = '';
        
        if (formation) {
          html += `
            <span class="mx-2 text-gray-500">/</span>
            <span class="cursor-pointer hover:text-white" onclick="loadFormations()">${formation}</span>
          `;
          
          if (module) {
            html += `
              <span class="mx-2 text-gray-500">/</span>
              <span class="text-gray-300">${module}</span>
            `;
          }
        }
        
        breadcrumb.innerHTML = html;
      }

      // Security Utils
      const SecurityUtils = {
        escapeHtml(unsafe) {
          return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
        },

        validateId(id) {
          return /^[a-zA-Z0-9-_]+$/.test(id);
        },

        validateYoutubeUrl(url) {
          const youtubeRegex =
            /^(https?:\/\/)?(www\.)?(youtube\.com\/watch\?v=|youtu\.be\/)[\w-]{11}$/;
          return youtubeRegex.test(url);
        },

        getCsrfToken() {
          return document
            .querySelector('meta[name="csrf-token"]')
            ?.getAttribute("content");
        },

        getHeaders() {
          return {
            "Content-Type": "application/json",
            "X-CSRF-Token": this.getCsrfToken(),
          };
        },
      };

      // Rate Limiter
      const RateLimiter = {
        limits: {},

        canPerformAction(action, minInterval = 1000) {
          const now = Date.now();
          if (this.limits[action] && now - this.limits[action] < minInterval) {
            return false;
          }
          this.limits[action] = now;
          return true;
        },
      };

      window.SecurityUtils = SecurityUtils;
      window.RateLimiter = RateLimiter;

      // API Client
      const ApiClient = {
        async fetchWithSecurity(url, options = {}) {
          try {
            const response = await fetch(url, {
              ...options,
              headers: {
                ...SecurityUtils.getHeaders(),
                ...options.headers,
              },
              credentials: "include", // Important pour les cookies d'authentification
            });

            if (!response.ok) {
              const error = await response.json();
              throw new Error(error.message || "Une erreur est survenue");
            }

            return await response.json();
          } catch (error) {
            console.error("API Error:", error);
            throw error;
          }
        },

        async getFormations() {
          return this.fetchWithSecurity("/formations");
        },

        async getFormation(id) {
          if (!SecurityUtils.validateId(id)) throw new Error("ID invalide");
          return this.fetchWithSecurity(`/formations/${id}`);
        },

        async getModules(formationId) {
          if (!SecurityUtils.validateId(formationId))
            throw new Error("ID invalide");
          return this.fetchWithSecurity(`/formations/${formationId}/modules`);
        },

        async getModuleContent(formationId, moduleId) {
          if (
            !SecurityUtils.validateId(formationId) ||
            !SecurityUtils.validateId(moduleId)
          ) {
            throw new Error("ID invalide");
          }
          return this.fetchWithSecurity(
            `/formations/${formationId}/modules/${moduleId}/content`
          );
        },

        async getModuleStatus(formationId, moduleId) {
          if (
            !SecurityUtils.validateId(formationId) ||
            !SecurityUtils.validateId(moduleId)
          ) {
            throw new Error("ID invalide");
          }
          return this.fetchWithSecurity(
            `/formations/${formationId}/modules/${moduleId}/status`
          );
        },

        async saveProgress(formationId, moduleId, progressData) {
          if (!formationId || !moduleId || !progressData) {
            throw new Error(
              "Param√®tres manquants pour la sauvegarde de la progression"
            );
          }

          if (
            !SecurityUtils.validateId(formationId) ||
            !SecurityUtils.validateId(moduleId)
          ) {
            throw new Error("ID de formation ou de module invalide");
          }

          if (
            !progressData.type ||
            !["video", "reading", "quiz"].includes(progressData.type)
          ) {
            throw new Error("Type de progression invalide");
          }

          if (typeof progressData.value !== "number") {
            throw new Error("Valeur de progression invalide");
          }

          return this.fetchWithSecurity(
            `/formations/${formationId}/modules/${moduleId}/progress`,
            {
              method: "POST",
              body: JSON.stringify(progressData),
              headers: {
                "Content-Type": "application/json",
              },
            }
          );
        },

        async inscrireFormation(formationId) {
          if (!SecurityUtils.validateId(formationId)) {
            throw new Error("ID invalide");
          }

          return this.fetchWithSecurity(
            `/formations/${formationId}/inscription`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
            }
          );
        },

        async getProgression(formationId) {
          if (!SecurityUtils.validateId(formationId)) {
            throw new Error("ID invalide");
          }
          return this.fetchWithSecurity(
            `/formations/${formationId}/progression`
          );
        },

        async getNextModule(formationId, currentModuleId) {
          if (
            !SecurityUtils.validateId(formationId) ||
            !SecurityUtils.validateId(currentModuleId)
          ) {
            throw new Error("ID invalide");
          }
          return this.fetchWithSecurity(
            `/formations/${formationId}/modules/${currentModuleId}/next`
          );
        },
      };

      // Progress Tracker
      const ProgressTracker = {
        state: null,
        videoInterval: null,
        readingInterval: null,

        async initializeState(formationId, moduleId) {
          try {
            const response = await ApiClient.fetchWithSecurity(
              `/api/content/${formationId}/modules/${moduleId}/state`
            );
            this.state = response.state;
            if (window.updateChapterProgress) {
              window.updateChapterProgress(this.state);
            }
          } catch (error) {
            console.error("Erreur lors de l'initialisation de l'√©tat:", error);
          }
        },

        async saveProgress(type, value) {
          try {
            if (!window.currentFormationId || !window.currentModuleId) {
              console.error("Formation ID ou Module ID manquant");
              throw new Error(
                "Impossible de sauvegarder la progression : Formation ou Module non s√©lectionn√©"
              );
            }

            const progressData = { type, value };
            const response = await ApiClient.saveProgress(
              window.currentFormationId,
              window.currentModuleId,
              progressData
            );

            // Mise √† jour de l'√©tat local en fonction du type
            switch (type) {
              case "video":
                this.state.videoProgress = value;
                this.state.conditions.videoWatched = value >= 70;
                break;
              case "reading":
                this.state.readingTime = value;
                this.state.conditions.timeSpentReading = value >= 180;
                break;
              case "quiz":
                this.state.quizScore = value;
                this.state.conditions.quizPassed = value === 100;
                break;
            }

            if (window.updateChapterProgress) {
              window.updateChapterProgress(this.state);
            }

            return response;
          } catch (error) {
            console.error(
              "Erreur lors de la sauvegarde de la progression:",
              error
            );
            throw error;
          }
        },

        initializeVideoTracking(iframe) {
          if (this.videoInterval) {
            clearInterval(this.videoInterval);
            this.videoInterval = null;
          }

          let player;
          let lastProgress = 0;

          window.onYouTubeIframeAPIReady = () => {
            player = new YT.Player(iframe, {
              events: {
                onStateChange: async (event) => {
                  if (event.data === YT.PlayerState.PLAYING) {
                    if (!this.videoInterval) {
                      this.videoInterval = setInterval(async () => {
                        try {
                          const duration = player.getDuration();
                          const currentTime = player.getCurrentTime();

                          if (duration && duration > 0) {
                            const progress = Math.min(
                              Math.round((currentTime / duration) * 100),
                              100
                            );

                            if (Math.abs(progress - lastProgress) >= 5) {
                              lastProgress = progress;
                              await this.saveProgress("video", progress);
                            }
                          }
                        } catch (error) {
                          console.error("Erreur lors du suivi vid√©o:", error);
                          if (this.videoInterval) {
                            clearInterval(this.videoInterval);
                            this.videoInterval = null;
                          }
                        }
                      }, 2000);
                    }
                  } else if (
                    this.videoInterval &&
                    (event.data === YT.PlayerState.PAUSED ||
                      event.data === YT.PlayerState.ENDED)
                  ) {
                    clearInterval(this.videoInterval);
                    this.videoInterval = null;
                  }
                },
              },
            });
          };

          if (!window.YT) {
            const tag = document.createElement("script");
            tag.src = "https://www.youtube.com/iframe_api";
            const firstScriptTag = document.getElementsByTagName("script")[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
          } else if (window.YT.Player) {
            window.onYouTubeIframeAPIReady();
          }

          const cleanup = () => {
            if (this.videoInterval) {
              clearInterval(this.videoInterval);
              this.videoInterval = null;
            }
          };

          window.addEventListener("beforeunload", cleanup);
          const contentDisplay = document.getElementById("contentDisplay");
          if (contentDisplay) {
            contentDisplay.addEventListener("DOMNodeRemoved", cleanup, {
              once: true,
            });
          }
        },

        startReadingTracking() {
          if (this.readingInterval) {
            clearInterval(this.readingInterval);
            this.readingInterval = null;
          }

          const contentBody = document.querySelector(".content-body");
          if (!contentBody) return;

          const startTime = Date.now() - (this.state?.readingTime || 0) * 1000;
          this.readingInterval = setInterval(async () => {
            const currentTime = Math.floor((Date.now() - startTime) / 1000);
            await this.saveProgress("reading", currentTime);
          }, 1000);

          contentBody.addEventListener("scroll", async () => {
            const scrollPercentage =
              (contentBody.scrollTop /
                (contentBody.scrollHeight - contentBody.clientHeight)) *
              100;
            if (scrollPercentage > 70) {
              this.state.conditions.timeSpentReading = true;
              if (window.updateChapterProgress) {
                window.updateChapterProgress(this.state);
              }
            }
          });

          const cleanup = () => {
            if (this.readingInterval) {
              clearInterval(this.readingInterval);
              this.readingInterval = null;
            }
          };

          window.addEventListener("beforeunload", cleanup);
          contentBody.addEventListener("DOMNodeRemoved", cleanup, {
            once: true,
          });
        },

        async updateModuleVisuals() {
          try {
            const moduleItems = document.querySelectorAll(".module-item");
            for (const item of moduleItems) {
              const moduleId = item.dataset.moduleId;
              const statusIcon = item.querySelector(".status-icon i");

              if (!moduleId || !statusIcon) continue;

              const [state, lockStatus] = await Promise.all([
                ApiClient.fetchWithSecurity(
                  `/api/content/${window.currentFormationId}/modules/${moduleId}/state`
                ),
                ApiClient.fetchWithSecurity(
                  `/api/content/${window.currentFormationId}/modules/${moduleId}/lock-status`
                ),
              ]);

              if (lockStatus.isLocked) {
                statusIcon.className = "fas fa-lock text-red-500";
                item.classList.add("locked");
                item.style.pointerEvents = "none";
                item.style.opacity = "0.6";
                item.title = lockStatus.message || "Module verrouill√©";
              } else {
                const isCompleted =
                  state.conditions.videoWatched &&
                  state.conditions.timeSpentReading &&
                  state.conditions.quizPassed;

                if (isCompleted) {
                  statusIcon.className = "fas fa-check-circle text-green-500";
                  item.classList.add("completed");
                  item.classList.remove("locked");
                  item.style.pointerEvents = "auto";
                  item.style.opacity = "1";
                } else {
                  statusIcon.className = "fas fa-circle text-gray-300";
                  item.classList.remove("completed", "locked");
                  item.style.pointerEvents = "auto";
                  item.style.opacity = "1";
                }
                item.title = "";
              }
            }
          } catch (error) {
            console.error("Erreur lors de la mise √† jour des visuels:", error);
          }
        },
      };

      // Rendre ProgressTracker disponible globalement
      window.ProgressTracker = ProgressTracker;

      // UI Manager
      const UI = {
        elements: {
          contentDisplay: document.getElementById("contentDisplay"),
          moduleList: document.getElementById("moduleList"),
          formationList: document.getElementById("formationList"),
          breadcrumb: document.querySelector(".breadcrumb"),
        },

        showLoading(element) {
          if (!element) return;
          element.innerHTML = `
                  <div class="loading-animation">
                      <div class="spinner"></div>
            </div>`;
        },

        updateProgressUI(state) {
          const allConditionsMet = Object.values(state.conditions).every(
            (condition) => condition
          );

          const nextButton = document.querySelector(".next-module-btn");
          if (nextButton) {
            nextButton.disabled = !allConditionsMet;

            if (allConditionsMet) {
              nextButton.classList.remove("opacity-50", "cursor-not-allowed");
              nextButton.classList.add(
                "hover:bg-blue-600",
                "transition-colors"
              );
            } else {
              nextButton.classList.add("opacity-50", "cursor-not-allowed");
              nextButton.classList.remove(
                "hover:bg-blue-600",
                "transition-colors"
              );
            }
          }
        },

        handleError(element, error) {
          if (!element) return;
          console.error("Error:", error);
          element.innerHTML = `
                  <div class="error-message">
                      <i class="fas fa-exclamation-circle"></i>
                      <span>${SecurityUtils.escapeHtml(
                        error.message || "Une erreur est survenue"
                      )}</span>
            </div>`;
        },
      };

      // Rendre UI disponible globalement
      window.UI = UI;

      // Initialisation
      document.addEventListener("DOMContentLoaded", async function () {
        // S'assurer que ProgressTracker est initialis√©
        if (!window.ProgressTracker) {
          window.ProgressTracker = ProgressTracker;
        }

        // R√©initialiser l'√©tat si n√©cessaire
        window.ProgressTracker.state = {
          videoProgress: 0,
          readingTime: 0,
          quizScore: 0,
          conditions: {
            videoWatched: false,
            timeSpentReading: false,
            quizPassed: false,
          },
        };

        let currentFormation = null;
        let currentModule = null;
        let currentModuleContent = null;
        window.currentFormationId = null;
        window.currentModuleId = null;

        // Fonction pour charger les formations
        window.loadFormations = async function () {
          const formationList = document.getElementById("formationList");
          if (!formationList) return;

          UI.showLoading(formationList);
          formationList.classList.remove("hidden");

          // Cacher la navbar cach√©e
          if (window.toggleNavbarHidden) {
            window.toggleNavbarHidden(false);
          }

          const moduleList = document.getElementById("moduleList");
          const contentDisplay = document.getElementById("contentDisplay");

          if (moduleList) moduleList.classList.add("hidden");
          if (contentDisplay) {
            contentDisplay.classList.add("hidden");
            contentDisplay.innerHTML = "";
          }

          currentFormation = null;
          currentModule = null;
          window.currentFormationId = null;
          window.currentModuleId = null;

          // Mettre √† jour le fil d'Ariane
          if (window.BreadcrumbManager) {
            window.BreadcrumbManager.clearPaths();
            window.BreadcrumbManager.addPath(name);
          }

          currentModuleContent = null;

          try {
            const formations = await ApiClient.getFormations();
            
            // R√©cup√©rer le nombre de modules pour chaque formation
            const formationsWithModules = await Promise.all(
              formations.map(async (formation) => {
                try {
                  const modules = await ApiClient.getModules(formation._id);
                  return {
                    ...formation,
                    moduleCount: modules.length
                  };
                } catch (error) {
                  console.error(`Erreur lors de la r√©cup√©ration des modules pour la formation ${formation._id}:`, error);
                  return {
                    ...formation,
                    moduleCount: 0
                  };
                }
              })
            );

            formationList.innerHTML = `
              <div class="formations-grid">
                ${formationsWithModules
                  .map(
                    (formation, index) => `
                    <div class="formation-card fade-in" style="animation-delay: ${index * 0.1}s" onclick="loadFormationDescription('${formation._id}', '${formation.nom}')">
                      <div class="formation-header">
                        <div class="formation-icon">
                          <i class="fas fa-graduation-cap"></i>
                        </div>
                        <h3 class="formation-title">${formation.nom}</h3>
                      </div>
                      <div class="formation-stats">
                        <div class="stat">
                          <i class="fas fa-book"></i>
                          <span>${formation.moduleCount} module${formation.moduleCount > 1 ? 's' : ''}</span>
                        </div>
                        <div class="stat">
                          <i class="fas fa-clock"></i>
                          <span>~${formation.moduleCount * 30}min</span>
                        </div>
                      </div>
                      <button class="formation-button" onclick="loadFormationDescription('${formation._id}', '${formation.nom}')">
                        Commencer la formation
                      </button>
                    </div>
                  `
                  )
                  .join("")}
              </div>`;
          } catch (error) {
            UI.handleError(formationList, error);
          }
        };

        // Fonction pour charger la description d'une formation
        window.loadFormationDescription = async function (id, name) {
          const contentDisplay = document.getElementById("contentDisplay");
          if (!contentDisplay) return;

          UI.showLoading(contentDisplay);
          contentDisplay.classList.remove("hidden");

          const formationList = document.getElementById("formationList");
          const moduleList = document.getElementById("moduleList");

          if (formationList) formationList.classList.add("hidden");
          if (moduleList) moduleList.classList.add("hidden");

          try {
            const formation = await ApiClient.getFormation(id);
            const modules = await ApiClient.getModules(id);
            
            contentDisplay.innerHTML = `
              <div class="inscription-container">
                <div class="inscription-header">
                  <h1 class="inscription-title">${formation.nom}</h1>
                  <p class="inscription-subtitle">D√©couvrez une nouvelle fa√ßon d'apprendre</p>
                </div>

                <div class="formation-details-wrapper">
                  <div class="formation-details">
                    <div class="detail-item">
                      <div class="detail-icon">
                        <i class="fas fa-book"></i>
                      </div>
                      <div class="detail-content">
                        <div class="detail-label">Modules</div>
                        <div class="detail-value">${modules.length} module${modules.length > 1 ? 's' : ''}</div>
                      </div>
                    </div>

                    <div class="detail-item">
                      <div class="detail-icon">
                        <i class="fas fa-clock"></i>
                      </div>
                      <div class="detail-content">
                        <div class="detail-label">Dur√©e estim√©e</div>
                        <div class="detail-value">~${modules.length * 30} minutes</div>
                      </div>
                    </div>

                    <div class="detail-item">
                      <div class="detail-icon">
                        <i class="fas fa-signal"></i>
                      </div>
                      <div class="detail-content">
                        <div class="detail-label">Niveau</div>
                        <div class="detail-value">Tous niveaux</div>
                      </div>
                    </div>

                    <div class="detail-item">
                      <div class="detail-icon">
                        <i class="fas fa-certificate"></i>
                      </div>
                      <div class="detail-content">
                        <div class="detail-label">Certification</div>
                        <div class="detail-value">Incluse</div>
                      </div>
                    </div>
                  </div>

                  <div class="formation-actions">
                    <button class="action-button secondary" onclick="loadFormations()">
                      <i class="fas fa-arrow-left"></i>
                      Retour
                    </button>
                    <button class="action-button primary" onclick="inscrireAFormation('${formation._id}', '${formation.nom}')">
                      <i class="fas fa-graduation-cap"></i>
                      S'inscrire √† la formation
                    </button>
                  </div>
                </div>

                <div class="formation-description">
                  <h3 class="description-title">
                    <i class="fas fa-info-circle"></i>
                    √Ä propos de cette formation
                  </h3>
                  <div class="description-content">
                    ${formation.description || ''}
                  </div>
                </div>
              </div>
            `;
          } catch (error) {
            UI.handleError(contentDisplay, error);
          }
        };

        // Fonction pour s'inscrire √† une formation
        window.inscrireAFormation = async function (id, name) {
          try {
            const response = await ApiClient.inscrireFormation(id);
            alert(response.message);
            loadModules(id, name);
          } catch (error) {
            console.error("Erreur lors de l'inscription:", error);
            alert("Erreur lors de l'inscription : " + error.message);
          }
        };

        // Fonction pour charger les modules
        window.loadModules = async function (id, name) {
          const moduleList = document.getElementById("moduleList");
          if (!moduleList) return;

          UI.showLoading(moduleList);
          moduleList.classList.remove("hidden");

          // Cacher la navbar cach√©e
          if (window.toggleNavbarHidden) {
            window.toggleNavbarHidden(false);
          }

          const formationList = document.getElementById("formationList");
          const contentDisplay = document.getElementById("contentDisplay");

          if (formationList) formationList.classList.add("hidden");
          if (contentDisplay) {
            contentDisplay.classList.add("hidden");
            contentDisplay.innerHTML = "";
          }

          currentFormation = name;
          window.currentFormationId = id;
          currentModule = null;
          window.currentModuleId = null;

          // Mettre √† jour le fil d'Ariane
          updateBreadcrumb(name);

          currentModuleContent = null;

          try {
            const [modules, progression] = await Promise.all([
              ApiClient.getModules(id),
              ApiClient.getProgression(id),
            ]);

            if (!modules || modules.length === 0) {
              moduleList.innerHTML = `
                <div class="module-message fade-in">
                    <p>Aucun module disponible pour cette formation.</p>
                </div>`;
              return;
            }

            moduleList.innerHTML = `
              <div class="modules-container">
                <div class="modules-header">
                  <h2>${currentFormation}</h2>
                  <p>S√©lectionnez un module pour commencer votre apprentissage</p>
                </div>
                <div class="modules-grid">
                  ${modules.map((module, index) => {
                    const moduleStatus = progression.find(
                      (p) => p.module && p.module.toString() === module._id.toString()
                    ) || {
                      isLocked: index > 0,
                      completed: false,
                      message: index === 0 ? "Premier module - Acc√®s autoris√©" : "Compl√©tez d'abord le module pr√©c√©dent"
                    };

                    return `
                      <div class="module-card ${moduleStatus.completed ? 'completed' : ''} ${moduleStatus.isLocked ? 'locked' : ''}"
                           data-module-id="${module._id}"
                           onclick="${!moduleStatus.isLocked ? `loadContent('${id}', '${module._id}', '${module.nom}')` : 'void(0)'}">
                        <div class="module-header">
                          <div class="module-icon">
                            <i class="fas fa-book"></i>
                          </div>
                          <div class="module-info">
                            <h3 class="module-title">${module.nom}</h3>
                            <div class="module-meta">
                              <span>
                                <i class="fas fa-clock"></i>
                                <span>${module.duree ? `~${module.duree}min` : 'Dur√©e non d√©finie'}</span>
                              </span>
                            </div>
                          </div>
                        </div>
                        <div class="module-progress">
                          <div class="progress-bar" style="width: ${moduleStatus.completed ? '100%' : '0%'}"></div>
                        </div>
                        ${moduleStatus.isLocked ? `
                          <div class="lock-message">
                            ${moduleStatus.message}
                          </div>
                        ` : ''}
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>`;

            // Ajouter les styles CSS
            const style = document.createElement("style");
            style.textContent = `
              .modules-container {
                max-width: 1400px;
                margin: 0 auto;
                padding: 2rem;
              }

              .modules-header {
                text-align: center;
                margin-bottom: 2rem;
              }

              .modules-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
                gap: 2rem;
              }

              .module-card {
                position: relative;
                background: linear-gradient(145deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
                border-radius: 1.5rem;
                padding: 2rem;
                transition: all 0.4s ease;
                cursor: pointer;
                border: none;
              }

              .module-card:not(.locked):hover {
                transform: translateY(-8px);
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
                background: linear-gradient(145deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.08));
              }

              .module-card.locked {
                cursor: not-allowed;
                opacity: 0.7;
                filter: grayscale(0.3);
              }

              .module-card.locked:hover {
                animation: shake 0.5s ease-in-out;
              }

              .module-card.locked .module-icon {
                background: linear-gradient(135deg, #475569 0%, #334155 100%);
              }

              .module-card.locked .status-icon {
                color: #ef4444;
              }

              .module-card.completed .status-icon {
                color: #22c55e;
              }

              .lock-message {
                position: absolute;
                bottom: 1rem;
                left: 1rem;
                right: 1rem;
                text-align: center;
                color: #94a3b8;
                font-size: 0.9rem;
                padding: 0.75rem;
                background: rgba(0, 0, 0, 0.2);
                border-radius: 0.5rem;
                opacity: 0;
                transform: translateY(10px);
                transition: all 0.3s ease;
              }

              .module-card.locked:hover .lock-message {
                opacity: 1;
                transform: translateY(0);
              }

              @keyframes shake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-5px); }
                75% { transform: translateX(5px); }
              }
            `;
            document.head.appendChild(style);

            // Mettre √† jour les visuels des modules
            await ProgressTracker.updateModuleVisuals();

            // R√©initialisation de l'√©tat
            ProgressTracker.state = {
              videoProgress: 0,
              readingTime: 0,
              quizScore: 0,
              conditions: {
                videoWatched: false,
                timeSpentReading: false,
                quizPassed: false,
              },
            };

            if (window.resetChapterProgress) {
              window.resetChapterProgress();
            }
            if (window.updateChapterInfo) {
              window.updateChapterInfo(name, null);
            }

            if (ProgressTracker.readingInterval) {
              clearInterval(ProgressTracker.readingInterval);
              ProgressTracker.readingInterval = null;
            }
          } catch (error) {
            console.error("Erreur lors du chargement:", error);
            UI.handleError(moduleList, error);
          }
        };

        // Fonction pour charger le contenu d'un module
        window.loadContent = async function (fId, mId, mName) {
          try {
            const contentDisplay = document.getElementById("contentDisplay");
            if (!contentDisplay) return;

            UI.showLoading(contentDisplay);
            contentDisplay.classList.remove("hidden");
            
            // Afficher la navbar cach√©e
            if (window.toggleNavbarHidden) {
              window.toggleNavbarHidden(true);
            }

            const moduleList = document.getElementById("moduleList");
            if (moduleList) moduleList.classList.add("hidden");

            currentModule = mName;
            window.currentModuleId = mId;
            window.currentFormationId = fId;
            window.currentFormation = currentFormation;

            // Mettre √† jour le fil d'Ariane
            updateBreadcrumb(currentFormation, mName);

            // Initialiser l'√©tat depuis le backend
            await ProgressTracker.initializeState(fId, mId);

            if (window.updateChapterInfo) {
              window.updateChapterInfo(currentFormation, mName);
            }

            const content = await ApiClient.getModuleContent(fId, mId);
            currentModuleContent = content;

            if (content.video) {
              await renderVideoContent(content, currentModule);
            } else {
              await renderTextContent(content, currentModule);
            }

            UI.updateProgressUI(ProgressTracker.state);
          } catch (error) {
            console.error("Erreur dans loadContent:", error);
            UI.handleError(contentDisplay, error);
          }
        };

        // Fonction pour le rendu du contenu vid√©o
        async function renderVideoContent(content, currentModule) {
          const contentDisplay = document.getElementById("contentDisplay");
          let videoId = "";
          const videoUrl = content.video.trim();

          if (videoUrl.includes("youtube.com/watch")) {
            videoId = videoUrl.split("v=")[1]?.split("&")[0];
          } else if (videoUrl.includes("youtu.be")) {
            videoId = videoUrl.split("youtu.be/")[1]?.split("?")[0];
          }

          if (videoId) {
            contentDisplay.innerHTML = `
            <div class="content-header fade-in">
                <h2>Vid√©o: ${currentModule}</h2>
            </div>
            <div class="content-body fade-in">
                <div class="video-container">
                    <iframe 
                        id="player"
                        src="https://www.youtube.com/embed/${videoId}?enablejsapi=1" 
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen>
                    </iframe>
                </div>
            </div>`;

            const iframe = contentDisplay.querySelector("iframe");
            ProgressTracker.initializeVideoTracking(iframe);
          }
        }

        // Fonction pour le rendu du contenu textuel
        async function renderTextContent(content, currentModule) {
          const contentDisplay = document.getElementById("contentDisplay");
          contentDisplay.innerHTML = `
        <div class="content-header fade-in">
            <h2>${currentModule}</h2>
        </div>
        <div class="content-body fade-in">
            <p class="content-description">${content.description || ""}</p>
            <div class="module-content w-full">
                ${content.course || ""}
            </div>
            <button class="next-module-btn mt-4 px-4 py-2 bg-blue-500 text-white rounded disabled:opacity-50"
                    ${
                      !Object.values(ProgressTracker.state.conditions).every(
                        Boolean
                      )
                        ? "disabled"
                        : ""
                    }
                        onclick="loadModules('${
                          window.currentFormationId
                        }', '${currentFormation}')">
                Module Suivant
            </button>
        </div>`;

          ProgressTracker.startReadingTracking();
        }

        // Chargement initial
        loadFormations();
      });
    </script>
    <script src="https://www.youtube.com/iframe_api"></script>
  </body>
</html>
